<!DOCTYPE html>
<html dir="rtl" lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>همسر پرفیوم - فروشگاه تخصصی عطرهای لاکچری</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <style>
        :root {
            --primary: #1a1a2e;
            --secondary: #2d4263;
            --accent: #c84b31;
            --accent-light: #d66853;
            --light: #f8f5f1;
            --dark: #191919;
            --text: #333;
            --white: #ffffff;
            --gray: #f8f9fa;
            --success: #4CAF50;
            --gradient: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            --transition: all 0.3s ease;
            --shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
            --radius: 12px;
            --glass: rgba(255, 255, 255, 0.15);
            --glass-dark: rgba(26, 26, 46, 0.8);
            --blur: blur(10px);
            --safe-area-inset-top: env(safe-area-inset-top);
            --safe-area-inset-right: env(safe-area-inset-right);
            --safe-area-inset-bottom: env(safe-area-inset-bottom);
            --safe-area-inset-left: env(safe-area-inset-left);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Vazirmatn', Tahoma, sans-serif;
            background-color: var(--white);
            color: var(--text);
            line-height: 1.6;
            overflow-x: hidden;
            font-weight: 300;
            padding-bottom: env(safe-area-inset-bottom);
        }

        body.modal-open {
            overflow: hidden;
        }
        
        /* Header Styles - Mobile First */
        .header {
            background: var(--white);
            padding: 12px 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            padding-top: calc(12px + var(--safe-area-inset-top));
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .header-container {
            display: grid;
            grid-template-columns: auto 1fr auto;
            align-items: center;
            gap: 15px;
            padding: 0 15px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .logo {
            display: flex;
            align-items: center;
            color: var(--primary);
            text-decoration: none;
            font-size: 18px;
            font-weight: 700;
            gap: 8px;
            justify-self: center;
        }
        
        .logo-text {
            font-weight: 800;
            color: var(--primary);
            letter-spacing: -0.5px;
            display: none;
        }
        
        .logo-image {
            width: 60px;
            height: 30px;
            border-radius: 8px;
            object-fit: cover;
            transition: transform 0.3s ease;
        }
        
        .nav-desktop {
            display: none;
        }
        
        .header-icons {
            display: flex;
            gap: 15px;
            align-items: center;
            justify-self: end;
        }
        
        .icon-btn {
            background: none;
            border: none;
            color: var(--primary);
            font-size: 18px;
            cursor: pointer;
            position: relative;
            transition: var(--transition);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .icon-btn:hover {
            color: var(--accent);
            background-color: rgba(200, 75, 49, 0.1);
        }
        
        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            cursor: pointer;
            border: 1px solid var(--accent-light);
            transition: var(--transition);
        }
        
        .user-avatar:hover {
            transform: scale(1.1);
        }
        
        .badge {
            position: absolute;
            top: -5px;
            left: -5px;
            background: var(--accent);
            color: var(--white);
            font-size: 10px;
            font-weight: bold;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Hamburger Menu */
        .hamburger {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            width: 28px;
            height: 20px;
            cursor: pointer;
            z-index: 1001;
        }
        
        .hamburger span {
            height: 2px;
            width: 100%;
            background: var(--primary);
            border-radius: 3px;
            transition: var(--transition);
        }
        
        .hamburger.active span:nth-child(1) {
            transform: rotate(45deg) translate(5px, 5px);
        }
        
        .hamburger.active span:nth-child(2) {
            opacity: 0;
        }
        
        .hamburger.active span:nth-child(3) {
            transform: rotate(-45deg) translate(7px, -6px);
        }
        
        .mobile-menu {
            position: fixed;
            top: 0;
            right: -100%;
            width: 85%;
            max-width: 300px;
            height: 100vh;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: var(--blur);
            z-index: 1000;
            transition: var(--transition);
            padding: 80px 20px 20px;
            overflow-y: auto;
            box-shadow: -2px 0 10px rgba(0,0,0,0.05);
            border-left: 1px solid rgba(0, 0, 0, 0.05);
            padding-bottom: calc(20px + var(--safe-area-inset-bottom));
        }
        
        .mobile-menu.active {
            right: 0;
        }
        
        .mobile-nav {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .mobile-nav-link {
            color: var(--primary);
            text-decoration: none;
            font-size: 16px;
            padding: 12px 15px;
            border-radius: 8px;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(248, 249, 250, 0.5);
        }
        
        .mobile-nav-link:hover {
            background: rgba(200, 75, 49, 0.1);
            padding-right: 20px;
        }
        
        .mobile-nav-link i {
            font-size: 18px;
            min-width: 22px;
            color: var(--accent);
        }
        
        /* General Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            padding: 15px;
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: var(--blur);
            width: 100%;
            border-radius: 12px;
            padding: 20px;
            position: relative;
            box-shadow: 0 15px 30px rgba(0,0,0,0.1);
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .close-modal-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background: var(--accent);
            color: white;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            font-size: 14px;
            cursor: pointer;
            z-index: 10;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Auth Modal */
        #authModal .modal-content {
            max-width: 500px;
        }
        
        .auth-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .auth-tab {
            padding: 10px 20px;
            cursor: pointer;
            font-weight: 600;
            color: #777;
            transition: var(--transition);
            position: relative;
            font-size: 14px;
        }
        
        .auth-tab.active {
            color: var(--accent);
        }
        
        .auth-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            right: 0;
            width: 100%;
            height: 2px;
            background: var(--accent);
        }
        
        .auth-form {
            display: none;
        }
        
        .auth-form.active {
            display: block;
        }
        
        .auth-form-group {
            margin-bottom: 15px;
        }
        
        .auth-form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 400;
            color: var(--dark);
            font-size: 14px;
        }
        
        .auth-form-input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #eee;
            border-radius: 8px;
            font-size: 15px;
            transition: var(--transition);
            font-family: 'Vazirmatn', Tahoma, sans-serif;
            background: #f9f9f9;
        }
        
        .auth-form-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(200, 75, 49, 0.2);
        }
        
        .auth-form-button {
            width: 100%;
            padding: 12px;
            background: var(--accent);
            color: var(--white);
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            margin-top: 10px;
        }
        
        .auth-form-button:hover {
            background: var(--accent-light);
            transform: translateY(-2px);
        }
        
        .auth-form-footer {
            text-align: center;
            margin-top: 15px;
            color: #777;
            font-size: 14px;
        }
        
        .auth-form-footer a {
            color: var(--accent);
            text-decoration: none;
            font-weight: 500;
        }
        
        .auth-divider {
            display: flex;
            align-items: center;
            margin: 20px 0;
            color: #777;
            font-size: 14px;
        }
        
        .auth-divider::before,
        .auth-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #eee;
        }
        
        .auth-divider::before {
            margin-left: 12px;
        }
        
        .auth-divider::after {
            margin-right: 12px;
        }
        
        .auth-social-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .auth-social-button {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid #eee;
            background: white;
            color: #333;
            font-size: 14px;
        }
        
        .auth-social-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .auth-social-button i {
            margin-left: 8px;
            font-size: 18px;
        }
        
        .auth-social-button.google {
            color: #DB4437;
            border-color: #DB4437;
        }
        
        /* User Dropdown */
        .user-dropdown {
            position: relative;
        }
        
        .user-dropdown-menu {
            position: absolute;
            top: 45px;
            left: 0;
            background: white;
            min-width: 180px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: all 0.3s ease;
        }
        
        .user-dropdown:hover .user-dropdown-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .user-dropdown-item {
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--dark);
            text-decoration: none;
            transition: var(--transition);
            cursor: pointer;
            font-size: 14px;
        }
        
        .user-dropdown-item:first-child {
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }
        
        .user-dropdown-item:last-child {
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
        }
        
        .user-dropdown-item:hover {
            background: #f8f9fa;
            color: var(--accent);
        }
        
        .user-dropdown-item i {
            width: 18px;
            text-align: center;
        }
        
        /* Hero Section */
        .hero {
            height: 300px;
            background: url(http://hamsar.wuaze.com/wp-content/uploads/2024/03/bg-10.jpg) no-repeat center center;
            background-size: cover;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 0 15px;
            position: relative;
            overflow: hidden;
            margin: 15px;
            border-radius: 12px;
        }

        .hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 0;
            border-radius: 12px;
        }

        .hero-content {
            max-width: 800px;
            position: relative;
            z-index: 1;
        }

        .hero-title {
            font-size: 1.8rem;
            color: var(--white);
            margin-bottom: 15px;
            font-weight: 700;
            line-height: 1.2;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .hero-subtitle {
            font-size: 1rem;
            color: var(--white);
            margin-bottom: 30px;
            font-weight: 300;
            text-shadow: 0 1px 5px rgba(0,0,0,0.3);
        }

        /* Products Section */
        .section {
            padding: 40px 15px;
        }
        
        .section-title {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }
        
        .section-title h2 {
            font-size: 1.5rem;
            color: var(--dark);
            font-weight: 400;
            display: inline-block;
            padding-bottom: 12px;
            position: relative;
        }
        
        .section-title h2::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 2px;
            background: var(--accent);
        }
        
        .products-container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .products-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 15px;
        }
        
        .product-card {
            background: var(--white);
            border-radius: var(--radius);
            overflow: hidden;
            transition: var(--transition);
            position: relative;
            transform: translateY(0);
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(240, 240, 240, 0.8);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .product-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow);
        }
        
        .product-image {
            height: 160px;
            background-color: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            cursor: pointer;
            overflow: hidden;
            aspect-ratio: 1/1;
        }
        
        .product-image img {
            width: 70%;
            height: 70%;
            object-fit: contain;
            transition: var(--transition);
            position: relative;
            z-index: 2;
        }
        
        .product-card:hover .product-image img {
            transform: scale(1.05);
        }
        
        .product-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background: var(--accent);
            color: var(--white);
            padding: 4px 10px;
            border-radius: 30px;
            font-size: 10px;
            font-weight: 500;
            z-index: 3;
        }
        
        .product-info {
            padding: 15px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .product-title {
            font-size: 14px;
            font-weight: 400;
            margin-bottom: 10px;
            color: var(--dark);
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.4;
        }
        
        .product-title:hover {
            color: var(--accent);
        }
        
        .product-bottom {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
        }
        
        .product-price {
            font-size: 14px;
            font-weight: 500;
            color: var(--accent);
        }
        
        .product-actions {
            display: flex;
            gap: 8px;
        }
        
        .action-btn {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gray);
            border: none;
            cursor: pointer;
            transition: var(--transition);
            font-size: 14px;
        }
        
        .action-btn:hover {
            background: var(--accent);
            color: white;
            transform: scale(1.1);
        }
        
        /* Side Modal (Cart, Wishlist, Checkout) */
        .side-modal {
            position: fixed;
            top: 0;
            right: -100%;
            width: 100%;
            max-width: 420px;
            height: 100vh;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: var(--blur);
            z-index: 1500;
            transition: right 0.4s ease;
            display: flex;
            flex-direction: column;
            box-shadow: -2px 0 15px rgba(0,0,0,0.08);
            border-left: 1px solid rgba(0, 0, 0, 0.05);
        }

        .side-modal.open {
            right: 0;
        }

        .side-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            flex-shrink: 0;
            padding-top: calc(15px + var(--safe-area-inset-top));
        }

        .side-modal-title {
            font-size: 20px;
            font-weight: 400;
            color: var(--dark);
        }

        .close-side-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #777;
            transition: var(--transition);
        }

        .close-side-modal:hover {
            transform: rotate(90deg);
        }

        .side-modal-body {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .side-modal-footer {
            padding: 20px;
            border-top: 1px solid #eee;
            flex-shrink: 0;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: var(--blur);
            padding-bottom: calc(20px + var(--safe-area-inset-bottom));
        }
        
        /* Cart Modal Specifics */
        .cart-item {
            display: flex;
            gap: 12px;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
        }
        
        .cart-item-image {
            width: 70px;
            height: 70px;
            background: #f5f5f5;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .cart-item-image img {
            max-width: 70%;
            max-height: 70%;
        }
        
        .cart-item-details {
            flex: 1;
        }
        
        .cart-item-name {
            font-weight: 500;
            margin-bottom: 6px;
            font-size: 14px;
        }
        
        .cart-item-size {
            font-size: 12px;
            color: #777;
            margin-bottom: 8px;
        }
        
        .cart-item-price {
            font-weight: 500;
            color: var(--accent);
            font-size: 15px;
        }
        
        .cart-item-remove {
            color: #ff6b6b;
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            align-self: flex-start;
            transition: var(--transition);
            padding: 5px;
        }
        
        .cart-item-remove:hover {
            transform: scale(1.1);
        }
        
        .cart-summary-row {
            display: flex;
            justify-content: space-between;
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 15px;
        }

        .final-total {
            display: flex;
            justify-content: space-between;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
        }
        
        .checkout-button {
            width: 100%;
            padding: 14px;
            background: var(--accent);
            color: var(--white);
            border: none;
            border-radius: 8px;
            font-weight: 500;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .checkout-button:hover {
            background: var(--accent-light);
            transform: translateY(-3px);
        }

        .checkout-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }
        
        /* Footer Styles */
        .footer {
            background: var(--dark);
            color: var(--white);
            padding: 50px 0 20px;
            padding-bottom: calc(20px + var(--safe-area-inset-bottom));
        }
        
        .footer-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .footer-section h3 {
            font-size: 18px;
            margin-bottom: 20px;
            color: var(--accent-light);
            position: relative;
            padding-bottom: 10px;
            font-weight: 500;
        }
        
        .footer-section h3::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 50px;
            height: 2px;
            background: var(--accent);
        }
        
        .footer-section p {
            margin-bottom: 15px;
            line-height: 1.8;
            font-size: 14px;
        }
        
        .footer-section ul {
            list-style: none;
        }
        
        .footer-section ul li {
            margin-bottom: 12px;
        }
        
        .footer-section ul li a {
            color: #ccc;
            text-decoration: none;
            transition: var(--transition);
            display: block;
            font-size: 14px;
        }
        
        .footer-section ul li a:hover {
            color: var(--accent-light);
        }
        
        .footer-contact li {
            display: flex;
            gap: 12px;
            margin-bottom: 15px;
            align-items: flex-start;
        }
        
        .footer-contact i {
            color: var(--accent);
            font-size: 18px;
            min-width: 20px;
            margin-top: 3px;
        }
        
        .contact-link {
            color: var(--white);
            text-decoration: none;
            transition: var(--transition);
        }
        
        .contact-link:hover {
            color: var(--accent-light);
            text-decoration: underline;
        }
        
        .social-links {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        .social-links a {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--white);
            border-radius: 50%;
            transition: var(--transition);
            font-size: 16px;
        }
        
        .social-links a:hover {
            background: var(--accent);
            color: var(--white);
            transform: translateY(-3px);
        }
        
        .copyright {
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: #aaa;
            font-size: 13px;
        }
        
        /* Responsive */
        @media (min-width: 576px) {
            .header-container {
                padding: 0 20px;
            }
            
            .logo-text {
                display: block;
            }
            
            .logo {
                font-size: 20px;
            }
            
            .logo-image {
                width: 70px;
                height: 35px;
            }
            
            .icon-btn {
                font-size: 20px;
                width: 44px;
                height: 44px;
            }
            
            .hero {
                height: 350px;
                margin: 20px;
            }
            
            .hero-title {
                font-size: 2.2rem;
            }
            
            .hero-subtitle {
                font-size: 1.2rem;
            }
            
            .section {
                padding: 50px 20px;
            }
            
            .products-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
                gap: 20px;
            }
            
            .product-image {
                height: 180px;
            }
            
            .product-title {
                font-size: 15px;
            }
            
            .product-price {
                font-size: 15px;
            }
            
            .footer-content {
                grid-template-columns: repeat(2, minmax(0, 1fr));
                gap: 30px;
            }
        }
        
        @media (min-width: 768px) {
            .header {
                padding: 15px 0;
            }
            
            .logo {
                font-size: 22px;
            }
            
            .logo-image {
                width: 80px;
                height: 40px;
            }
            
            .nav-desktop {
                display: flex;
                gap: 20px;
                justify-self: center;
            }
            
            .nav-link {
                color: var(--primary);
                text-decoration: none;
                font-weight: 400;
                transition: var(--transition);
                position: relative;
                padding: 8px 0;
                font-size: 15px;
            }
            
            .nav-link:hover {
                color: var(--accent);
            }
            
            .nav-link::after {
                content: '';
                position: absolute;
                bottom: 0;
                right: 0;
                width: 0;
                height: 1px;
                background: var(--accent);
                transition: width 0.3s ease;
            }
            
            .nav-link:hover::after {
                width: 100%;
            }
            
            .hamburger {
                display: none;
            }
            
            .hero {
                height: 400px;
            }
            
            .hero-title {
                font-size: 2.5rem;
            }
            
            .hero-subtitle {
                font-size: 1.3rem;
            }
            
            .section-title h2 {
                font-size: 1.8rem;
            }
            
            .products-grid {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }
            
            .product-image {
                height: 200px;
            }
            
            .product-title {
                font-size: 16px;
            }
            
            .product-price {
                font-size: 16px;
            }
            
            .footer-content {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }
        }
        
        @media (min-width: 992px) {
            .header-container {
                grid-template-columns: auto 1fr auto;
                padding: 0 30px;
            }
            
            .logo {
                justify-self: start;
            }
            
            .nav-desktop {
                gap: 25px;
            }
            
            .nav-link {
                font-size: 16px;
            }
            
            .header-icons {
                gap: 20px;
            }
            
            .hero {
                height: 450px;
                width: 90%;
                margin: 30px auto;
            }
            
            .hero-title {
                font-size: 3rem;
            }
            
            .hero-subtitle {
                font-size: 1.5rem;
            }
            
            .section {
                padding: 60px 30px;
            }
            
            .section-title h2 {
                font-size: 2rem;
            }
            
            .products-grid {
                grid-template-columns: repeat(4, minmax(0, 1fr));
                gap: 25px;
            }
            
            .product-image {
                height: 220px;
            }
            
            .footer-content {
                grid-template-columns: repeat(4, minmax(0, 1fr));
                padding: 0 30px;
                gap: 40px;
            }
        }
        
        @media (min-width: 1200px) {
            .header-container {
                max-width: 1400px;
                margin: 0 auto;
            }
            
            .hero {
                max-width: 1400px;
            }
            
            .products-container {
                padding: 0 30px;
            }
        }

        /* Toast notifications */
        .toast {
            position: fixed;
            bottom: 15px;
            right: 15px;
            background: rgba(26, 26, 46, 0.9);
            backdrop-filter: var(--blur);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            z-index: 10000;
            transition: all 0.3s;
            opacity: 0;
            transform: translateY(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-family: 'Vazirmatn', Tahoma, sans-serif;
            bottom: calc(15px + var(--safe-area-inset-bottom));
            max-width: calc(100% - 30px);
        }
        
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* Product Detail Modal */
        #productModal .modal-content {
            max-width: 900px;
            padding: 0;
        }

        .product-detail-container {
            display: flex;
            flex-direction: column;
        }
        
        @media (min-width: 768px) {
            .product-detail-container {
                flex-direction: row;
            }
        }
        
        .product-detail-image {
            flex: 1;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #ffffff;
            padding: 20px;
        }
        
        .product-detail-image img {
            max-width: 80%;
            max-height: 80%;
            object-fit: contain;
            transition: transform 0.3s ease;
        }
        
        .product-detail-image:hover img {
            transform: scale(1.05);
        }
        
        .product-detail-info {
            flex: 1;
            padding: 20px;
        }
        
        .product-detail-title {
            font-size: 22px;
            color: var(--dark);
            margin-bottom: 12px;
            font-weight: 500;
        }
        
        .product-detail-price {
            font-size: 20px;
            color: var(--accent);
            font-weight: 500;
            margin-bottom: 15px;
        }
        
        .product-detail-description {
            margin-bottom: 20px;
            line-height: 1.8;
            font-size: 14px;
        }
        
        .product-detail-specs {
            margin-bottom: 20px;
        }
        
        .spec-item {
            display: flex;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }
        
        .spec-title {
            font-weight: 500;
            min-width: 100px;
            color: var(--dark);
        }
        
        .spec-value {
            flex: 1;
        }
        
        .product-detail-sizes {
            margin-bottom: 20px;
        }
        
        .product-detail-sizes h3 {
            margin-bottom: 12px;
            font-size: 16px;
        }
        
        .size-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap: 8px;
        }
        
        .size-option-detail {
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            transition: var(--transition);
            background: var(--white);
            text-align: center;
        }
        
        .size-option-detail:hover, .size-option-detail.active {
            border-color: var(--accent);
            background: var(--accent);
            color: var(--white);
        }
        
        .size-price {
            display: block;
            font-weight: 500;
            margin-top: 5px;
            color: inherit;
        }
        
        .product-detail-actions {
            display: flex;
            gap: 12px;
            margin-top: 15px;
        }
        
        .add-to-cart-detail {
            flex: 1;
            background: var(--accent);
            color: var(--white);
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .add-to-cart-detail:hover {
            background: var(--accent-light);
            transform: translateY(-3px);
        }
        
        .wishlist-btn-detail {
            width: 44px;
            height: 44px;
            background: var(--white);
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            font-size: 16px;
        }
        
        .wishlist-btn-detail:hover, .wishlist-btn-detail.active {
            color: var(--accent);
            border-color: var(--accent);
            background: #fff0f3;
        }
        
        /* Overlay for modals */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        /* Size Selection Modal */
        #sizeModal .modal-content {
            max-width: 400px;
        }

        .size-modal-title {
            font-size: 18px;
            margin-bottom: 15px;
            color: var(--dark);
            text-align: center;
        }
        
        .size-options-modal {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .size-option-modal {
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            transition: var(--transition);
            background: var(--white);
            text-align: center;
        }
        
        .size-option-modal:hover, .size-option-modal.active {
            border-color: var(--accent);
            background: var(--accent);
            color: var(--white);
        }
        
        .size-price-modal {
            display: block;
            font-weight: 500;
            margin-top: 5px;
            color: inherit;
        }
        
        .add-to-cart-size {
            width: 100%;
            padding: 12px;
            background: var(--accent);
            color: var(--white);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            font-size: 14px;
        }
        
        .add-to-cart-size:hover {
            background: var(--accent-light);
        }
        
        /* Search Bar */
        .search-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: var(--blur);
            padding: 12px 15px;
            z-index: 1100;
            transform: translateY(-150%);
            transition: transform 0.4s ease;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            padding-top: calc(12px + var(--safe-area-inset-top));
        }
        
        .search-header.active {
            transform: translateY(0);
        }
        
        .search-header-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .close-search {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--primary);
            padding: 5px;
        }
        
        .search-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 50px;
            font-size: 15px;
            transition: var(--transition);
            background: #f9f9f9;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .search-results {
            max-height: 350px;
            overflow-y: auto;
            margin-top: 12px;
            border-radius: 8px;
            background: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            display: none;
        }
        
        .search-result-item {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .search-result-item:hover {
            background: #f9f9f9;
        }
        
        .search-result-image {
            width: 40px;
            height: 40px;
            object-fit: contain;
        }
        
        .search-result-name {
            font-weight: 500;
            font-size: 14px;
        }
        
        .search-result-category {
            font-size: 12px;
            color: #777;
        }

        /* Checkout Steps - Redesigned */
        .checkout-steps {
            display: flex;
            justify-content: space-around;
            margin-bottom: 25px;
            position: relative;
            padding: 0 5px;
        }

        .checkout-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
            flex: 1;
            text-align: center;
        }

        .step-indicator {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #e0e0e0;
            color: #999;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            margin-bottom: 6px;
            transition: all 0.4s ease;
            border: 2px solid #e0e0e0;
            font-size: 14px;
        }
        
        .step-indicator .fa-check {
            display: none;
        }
        
        .step-title {
            font-size: 12px;
            color: #777;
            text-align: center;
            font-weight: 400;
            transition: all 0.4s ease;
        }
        
        /* Active State */
        .checkout-step.active .step-indicator {
            background: var(--white);
            color: var(--accent);
            border-color: var(--accent);
        }
        .checkout-step.active .step-title {
            color: var(--accent);
            font-weight: 500;
        }
        
        /* Completed State */
        .checkout-step.completed .step-indicator {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }
        .checkout-step.completed .step-indicator .step-number {
            display: none;
        }
        .checkout-step.completed .step-indicator .fa-check {
            display: block;
        }
        .checkout-step.completed .step-title {
            color: var(--dark);
        }

        .checkout-progress-bar {
            position: absolute;
            top: 15px;
            left: 0;
            right: 0;
            height: 2px;
            background: #e0e0e0;
            z-index: 1;
        }

        .checkout-progress {
            height: 100%;
            background: var(--success);
            width: 0;
            transition: width 0.5s ease;
            border-radius: 2px;
        }


        /* Checkout Forms */
        .checkout-form-container {
            display: none;
        }

        .checkout-form-container.active {
            display: block;
        }

        .checkout-form {
            background: white;
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 400;
            color: var(--dark);
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #eee;
            border-radius: var(--radius);
            font-size: 15px;
            transition: var(--transition);
            font-family: 'Vazirmatn', Tahoma, sans-serif;
            background: #f9f9f9;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(200, 75, 49, 0.2);
        }
        
        .form-hint {
            font-size: 11px;
            color: #777;
            margin-top: 4px;
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .form-col {
            flex: 1;
            min-width: 120px;
        }

        .checkout-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 25px;
            flex-wrap: wrap;
            gap: 8px;
        }

        .btn {
            padding: 10px 20px;
            border-radius: var(--radius);
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            flex-grow: 1;
        }

        @media (min-width: 400px) {
            .btn { flex-grow: 0; }
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-light);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #555;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }
        
        .btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Shipping Methods */
        .shipping-methods {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 15px 0;
        }

        .shipping-method {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
        }

        .shipping-method:hover {
            border-color: var(--accent-light);
        }

        .shipping-method.selected {
            border-color: var(--accent);
            background: rgba(200, 75, 49, 0.05);
        }

        .shipping-method input {
            margin-left: 8px;
        }

        .shipping-method-content {
            flex: 1;
            margin-right: 8px;
        }

        .shipping-method-title {
            font-weight: 500;
            margin-bottom: 4px;
            font-size: 14px;
        }

        .shipping-method-desc {
            font-size: 12px;
            color: #777;
        }

        .shipping-method-price {
            font-weight: 500;
            color: var(--accent);
            font-size: 14px;
        }

        /* Payment Info */
        .payment-info {
            background: #f9f9f9;
            border-radius: var(--radius);
            padding: 15px;
            margin: 15px 0;
            border-left: 3px solid var(--accent);
        }

        .payment-info-title {
            font-weight: 500;
            margin-bottom: 12px;
            color: var(--dark);
            font-size: 16px;
        }

        .payment-info-details {
            line-height: 1.8;
            font-size: 14px;
        }

        /* File Upload */
        .file-upload {
            margin: 15px 0;
        }

        .file-upload-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 400;
            color: var(--dark);
            font-size: 14px;
        }

        .file-upload-input {
            display: none;
        }

        .file-upload-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            background: #f0f0f0;
            border: 1px dashed #ccc;
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
            font-size: 14px;
        }

        .file-upload-button:hover {
            background: #e0e0e0;
            border-color: var(--accent);
        }
        
        .file-upload-button .fa-check-circle {
            color: var(--success);
            display: none;
        }
        
        .file-upload-button.uploaded .fa-check-circle {
            display: inline-block;
        }

        .file-name {
            font-size: 13px;
            color: #777;
        }

        /* Order Summary & Review */
        .order-summary, .order-review {
            background: white;
            border-radius: var(--radius);
            padding: 15px;
            box-shadow: var(--shadow);
            margin-bottom: 15px;
        }

        .order-summary-title, .order-review-title {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 12px;
            color: var(--dark);
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }

        .order-summary-item, .order-review-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .order-review-item {
            flex-direction: column;
            align-items: flex-start;
            padding-bottom: 8px;
            border-bottom: 1px solid #f5f5f5;
        }
        
        .order-review-item:last-child {
            border-bottom: none;
        }
        
        .order-review-label {
            font-weight: 500;
            margin-bottom: 4px;
            font-size: 14px;
        }

        .order-review-value {
            color: #555;
            text-align: right;
            width: 100%;
            font-size: 14px;
        }

        .order-summary-total {
            font-weight: 500;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--dark);
        }

        /* Order Confirmation */
        .order-confirmation {
            text-align: center;
            padding: 30px 15px;
        }

        .order-confirmation-icon {
            font-size: 50px;
            color: var(--success);
            margin-bottom: 15px;
        }

        .order-confirmation-title {
            font-size: 20px;
            font-weight: 500;
            margin-bottom: 12px;
            color: var(--dark);
        }

        .order-confirmation-message {
            font-size: 14px;
            color: #555;
            margin-bottom: 25px;
            line-height: 1.6;
        }

        /* Custom Dropdown for Provinces/Cities */
        .custom-dropdown {
            position: relative;
        }
        .dropdown-list {
            position: absolute;
            top: 105%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #eee;
            border-radius: var(--radius);
            max-height: 180px;
            overflow-y: auto;
            z-index: 10;
            display: none;
        }
        .dropdown-item {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
        }
        .dropdown-item:hover {
            background-color: #f0f0f0;
        }

        /* Profile & Orders Modals */
        #profileModal .modal-content, #ordersModal .modal-content {
            max-width: 700px;
        }

        .profile-info, .orders-list {
            margin-top: 15px;
        }
        
        .order-item {
            background: #f9f9f9;
            padding: 12px;
            border-radius: var(--radius);
            margin-bottom: 12px;
            border-left: 3px solid var(--secondary);
        }
        .order-item-header {
            display: flex;
            justify-content: space-between;
            font-weight: 500;
            margin-bottom: 8px;
            font-size: 14px;
        }
        .order-status {
            padding: 3px 8px;
            border-radius: 5px;
            color: white;
            font-size: 11px;
        }
        .order-status.pending { background-color: #f39c12; }
        .order-status.shipped { background-color: #3498db; }
        .order-status.delivered { background-color: var(--success); }
        .order-status.cancelled { background-color: #e74c3c; }

        /* Swipe functionality for mobile */
        .swipe-area {
            position: relative;
            overflow: hidden;
        }
        
        .swipe-content {
            transition: transform 0.3s ease;
        }
        
        .swipe-actions {
            position: absolute;
            top: 0;
            right: -80px;
            height: 100%;
            display: flex;
            align-items: center;
            transition: right 0.3s ease;
        }
        
        .swipe-action-btn {
            width: 70px;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }
        
        .swipe-action-btn.delete {
            background-color: #ff6b6b;
        }
        
        .swipe-area.active .swipe-content {
            transform: translateX(-80px);
        }
        
        .swipe-area.active .swipe-actions {
            right: 0;
        }

        /* Pull to refresh */
        .pull-to-refresh {
            position: fixed;
            top: -50px;
            left: 0;
            width: 100%;
            text-align: center;
            padding: 15px;
            z-index: 100;
            transition: top 0.3s ease;
        }
        
        .pull-to-refresh.active {
            top: 0;
        }
        
        .pull-to-refresh i {
            font-size: 20px;
            color: var(--accent);
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Improved touch targets */
        .touch-target {
            min-height: 44px;
            min-width: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Performance optimizations */
        .will-change {
            will-change: transform, opacity;
        }

        /* Reduced motion for accessibility */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <!-- Pull to refresh indicator -->
    <div class="pull-to-refresh" id="pullToRefresh">
        <i class="fas fa-spinner"></i>
    </div>

    <header class="header">
        <div class="header-container">
            <div class="hamburger" id="hamburger">
                <span></span>
                <span></span>
                <span></span>
            </div>

            <nav class="nav-desktop">
                <a href="#" class="nav-link">خانه</a>
                <a href="#men" class="nav-link">عطر مردانه</a>
                <a href="#women" class="nav-link">عطر زنانه</a>
                <a href="#unisex" class="nav-link">یونی‌سکس</a>
                <a href="#contact" class="nav-link">تماس با ما</a>
            </nav>
            
            <a href="#" class="logo">
                <div class="logo-text">همسر پرفیوم</div>
                <img src="http://hamsar.wuaze.com/wp-content/uploads/2025/09/پروفایل6-Copy.png" alt="لوگو همسر پرفیوم" class="logo-image">
            </a>
            
            <div class="header-icons">
                <button class="icon-btn touch-target" id="searchIcon" aria-label="جستجو">
                    <i class="fas fa-search"></i>
                </button>
                <button class="icon-btn touch-target" id="wishlistIcon" aria-label="لیست علاقه‌مندی‌ها">
                    <i class="far fa-heart"></i>
                    <span class="badge" id="wishlistCount">0</span>
                </button>
                <button class="icon-btn touch-target" id="cartIcon" aria-label="سبد خرید">
                    <i class="fas fa-shopping-cart"></i>
                    <span class="badge" id="cartCount">0</span>
                </button>
                
                <div class="user-dropdown" id="userDropdown" style="display: none;">
                    <img src="https://via.placeholder.com/150" alt="پروفایل کاربر" class="user-avatar" id="userAvatar">
                    <div class="user-dropdown-menu">
                        <div class="user-dropdown-item" id="profileLink">
                            <i class="fas fa-user"></i> پروفایل
                        </div>
                        <div class="user-dropdown-item" id="ordersLink">
                            <i class="fas fa-shopping-bag"></i> سفارشات
                        </div>
                        <a href="/admin.html" class="user-dropdown-item" id="adminLink" style="display: none;">
                            <i class="fas fa-user-shield"></i> پنل مدیریت
                        </a>
                        <div class="user-dropdown-item" id="logoutLink">
                            <i class="fas fa-sign-out-alt"></i> خروج
                        </div>
                    </div>
                </div>
                
                <button class="icon-btn touch-target" id="loginBtn" aria-label="ورود به حساب کاربری">
                    <i class="fas fa-user"></i>
                </button>
            </div>
        </div>
        
        <div class="mobile-menu" id="mobileMenu">
            <nav class="mobile-nav">
                <a href="#" class="mobile-nav-link close-mobile-menu">
                    <i class="fas fa-home"></i> خانه
                </a>
                <a href="#men" class="mobile-nav-link close-mobile-menu">
                    <i class="fas fa-male"></i> عطر مردانه
                </a>
                <a href="#women" class="mobile-nav-link close-mobile-menu">
                    <i class="fas fa-female"></i> عطر زنانه
                </a>
                <a href="#unisex" class="mobile-nav-link close-mobile-menu">
                    <i class="fas fa-venus-mars"></i> یونی‌سکس
                </a>
                <a href="#contact" class="mobile-nav-link close-mobile-menu">
                    <i class="fas fa-phone"></i> تماس با ما
                </a>
                <a href="#" class="mobile-nav-link" id="mobileWishlist">
                    <i class="far fa-heart"></i> لیست علاقه‌مندی‌ها
                    <span class="badge" id="mobileWishlistCount">0</span>
                </a>
                <a href="#" class="mobile-nav-link" id="mobileCart">
                    <i class="fas fa-shopping-cart"></i> سبد خرید
                    <span class="badge" id="mobileCartCount">0</span>
                </a>
                <div class="mobile-nav-link" id="mobileProfile" style="display: none;">
                    <i class="fas fa-user"></i> پروفایل
                </div>
                 <div class="mobile-nav-link" id="mobileOrders" style="display: none;">
                    <i class="fas fa-shopping-bag"></i> سفارشات
                </div>
                <div class="mobile-nav-link" id="mobileLogout" style="display: none;">
                    <i class="fas fa-sign-out-alt"></i> خروج
                </div>
                <div class="mobile-nav-link" id="mobileLogin">
                    <i class="fas fa-sign-in-alt"></i> ورود / ثبت‌نام
                </div>
            </nav>
        </div>
    </header>
    
    <div class="modal" id="authModal">
        <div class="modal-content">
            <button class="close-modal-btn" id="closeAuthModal">&times;</button>
            <div class="auth-tabs">
                <div class="auth-tab active" data-tab="login">ورود</div>
                <div class="auth-tab" data-tab="register">ثبت‌نام</div>
            </div>
            
            <div class="auth-form active" id="loginForm">
                <div class="auth-form-group">
                    <label for="loginEmail" class="auth-form-label">ایمیل</label>
                    <input type="email" id="loginEmail" class="auth-form-input" placeholder="example@example.com">
                </div>
                <div class="auth-form-group">
                    <label for="loginPassword" class="auth-form-label">رمز عبور</label>
                    <input type="password" id="loginPassword" class="auth-form-input" placeholder="رمز عبور">
                </div>
                <button class="auth-form-button" id="loginButton">ورود به حساب</button>
                <div class="auth-form-footer">
                    حساب کاربری ندارید؟ <a href="#" id="showRegister">ثبت‌نام کنید</a>
                </div>
                <div class="auth-divider">یا</div>
                <div class="auth-social-buttons">
                    <button class="auth-social-button google" id="googleLogin">
                        <i class="fab fa-google"></i> ورود با گوگل
                    </button>
                </div>
            </div>
            
            <div class="auth-form" id="registerForm">
                <div class="auth-form-group">
                    <label for="registerName" class="auth-form-label">نام کامل</label>
                    <input type="text" id="registerName" class="auth-form-input" placeholder="نام و نام خانوادگی">
                </div>
                <div class="auth-form-group">
                    <label for="registerPhone" class="auth-form-label">شماره تماس</label>
                    <input type="tel" id="registerPhone" class="auth-form-input" placeholder="09xxxxxxxxx">
                </div>
                <div class="auth-form-group">
                    <label for="registerEmail" class="auth-form-label">ایمیل</label>
                    <input type="email" id="registerEmail" class="auth-form-input" placeholder="example@example.com">
                </div>
                <div class="auth-form-group">
                    <label for="registerPassword" class="auth-form-label">رمز عبور</label>
                    <input type="password" id="registerPassword" class="auth-form-input" placeholder="حداقل ۶ کاراکتر">
                </div>
                <div class="auth-form-group">
                    <label for="registerConfirmPassword" class="auth-form-label">تکرار رمز عبور</label>
                    <input type="password" id="registerConfirmPassword" class="auth-form-input" placeholder="تکرار رمز عبور">
                </div>
                <button class="auth-form-button" id="registerButton">ثبت‌نام</button>
                <div class="auth-form-footer">
                    حساب کاربری دارید؟ <a href="#" id="showLogin">وارد شوید</a>
                </div>
                <div class="auth-divider">یا</div>
                <div class="auth-social-buttons">
                    <button class="auth-social-button google" id="googleRegister">
                        <i class="fab fa-google"></i> ثبت‌نام با گوگل
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="search-header" id="searchHeader">
        <div class="search-header-container">
            <button class="close-search" id="closeSearch">
                <i class="fas fa-arrow-right"></i>
            </button>
            <input type="text" class="search-input" id="searchInput" placeholder="جستجوی محصولات...">
        </div>
        <div class="search-results" id="searchResults"></div>
    </div>
    
    <section class="hero">
        <div class="hero-content">
            <h1 class="hero-title">کشف رایحه‌های منحصر به فرد</h1>
            <p class="hero-subtitle">با بهترین عطرهای اورجینال از همسر پرفیوم</p>
        </div>
    </section>
    
    <section class="section" id="men">
        <div class="section-title">
            <h2>عطرهای مردانه</h2>
        </div>
        <div class="products-container">
            <div class="products-grid" id="menPerfumes"></div>
        </div>
    </section>
    
    <section class="section" style="background: #f8f9fa;" id="women">
        <div class="section-title">
            <h2>عطرهای زنانه</h2>
        </div>
        <div class="products-container">
            <div class="products-grid" id="womenPerfumes"></div>
        </div>
    </section>
    
    <section class="section" id="unisex">
        <div class="section-title">
            <h2>عطرهای یونی‌سکس</h2>
        </div>
        <div class="products-container">
            <div class="products-grid" id="unisexPerfumes"></div>
        </div>
    </section>
    
    <section class="section" id="contact">
        <div class="section-title">
            <h2>تماس با ما</h2>
        </div>
        <div class="products-container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>درباره ما</h3>
                    <p>همسر پرفیوم با سال‌ها تجربه در زمینه عرضه عطرهای اورجینال و لاکچری، ارائه‌دهنده بهترین برندهای جهانی با قیمتی مناسب است.</p>
                    <div class="social-links">
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-telegram"></i></a>
                        <a href="#"><i class="fab fa-whatsapp"></i></a>
                    </div>
                </div>
                
                <div class="footer-section">
                    <h3>لینک‌های سریع</h3>
                    <ul>
                        <li><a href="#">خانه</a></li>
                        <li><a href="#men">عطرهای مردانه</a></li>
                        <li><a href="#women">عطرهای زنانه</a></li>
                        <li><a href="#unisex">عطرهای یونی‌سکس</a></li>
                        <li><a href="#">حریم خصوصی</a></li>
                    </ul>
                </div>
                
                <div class="footer-section">
                    <h3>اطلاعات تماس</h3>
                    <div class="footer-contact">
                        <li>
                            <i class="fas fa-map-marker-alt"></i>
                            <span>تهران، خیابان ولیعصر، کوچه فلان، پلاک ۱۲۳</span>
                        </li>
                        <li>
                            <i class="fas fa-phone"></i>
                            <a href="tel:+982112345678" class="contact-link">۰۲۱-۱۲۳۴۵۶۷۸</a>
                        </li>
                        <li>
                            <i class="fas fa-envelope"></i>
                            <a href="mailto:info@hamsarperfume.com" class="contact-link">info@hamsarperfume.com</a>
                        </li>
                    </div>
                </div>
                
                <div class="footer-section">
                    <h3>ساعات کاری</h3>
                    <p>شنبه تا پنجشنبه: ۹ صبح تا ۱۰ شب</p>
                    <p>جمعه‌ها: ۱۰ صبح تا ۸ شب</p>
                    <p>ارسال به تمام نقاط کشور</p>
                </div>
            </div>
        </div>
    </section>
    
    <footer class="footer">
        <div class="copyright">
            <p>© ۲۰۲۳ - تمام حقوق این وبسایت متعلق به همسر پرفیوم می‌باشد.</p>
        </div>
    </footer>
    
    <div class="side-modal" id="cartModal">
        <div class="side-modal-header">
            <h3 class="side-modal-title">سبد خرید شما</h3>
            <button class="close-side-modal" id="closeCart">&times;</button>
        </div>
        <div class="side-modal-body" id="cartItems">
            <!-- Cart items will be populated here -->
        </div>
        <div class="side-modal-footer">
            <div class="cart-summary-row final-total">
                <span>جمع کل:</span>
                <span id="cartTotal">۰ تومان</span>
            </div>
            <button class="checkout-button" id="checkoutButton">
                <i class="fas fa-arrow-left"></i> تایید و ادامه سفارش
            </button>
        </div>
    </div>
    
    <div class="side-modal" id="checkoutModal">
        <div class="side-modal-header">
            <h3 class="side-modal-title">تکمیل سفارش</h3>
            <button class="close-side-modal" id="closeCheckout">&times;</button>
        </div>
        <div class="side-modal-body">
            <div class="checkout-steps">
                 <div class="checkout-progress-bar">
                    <div class="checkout-progress" id="checkoutProgress"></div>
                </div>
                <div class="checkout-step active" id="stepNode1">
                    <div class="step-indicator"><span class="step-number">1</span><i class="fas fa-check"></i></div>
                    <div class="step-title">اطلاعات ارسال</div>
                </div>
                <div class="checkout-step" id="stepNode2">
                    <div class="step-indicator"><span class="step-number">2</span><i class="fas fa-check"></i></div>
                    <div class="step-title">روش ارسال</div>
                </div>
                <div class="checkout-step" id="stepNode3">
                    <div class="step-indicator"><span class="step-number">3</span><i class="fas fa-check"></i></div>
                    <div class="step-title">پرداخت</div>
                </div>
            </div>
            
            <div class="checkout-form-container active" id="shippingInfoForm">
                <div class="checkout-form">
                    <div class="form-group">
                        <label for="fullName" class="form-label">نام و نام خانوادگی گیرنده</label>
                        <input type="text" id="fullName" class="form-control" placeholder="نام کامل به فارسی یا انگلیسی">
                    </div>
                    <div class="form-group">
                        <label for="phoneNumber" class="form-label">شماره تماس گیرنده</label>
                        <input type="tel" id="phoneNumber" class="form-control" placeholder="09xxxxxxxxx">
                         <p class="form-hint">لطفا شماره تماس را با اعداد انگلیسی وارد کنید.</p>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="province" class="form-label">استان</label>
                                <div class="custom-dropdown">
                                    <input type="text" id="province" class="form-control" placeholder="جستجو یا انتخاب استان">
                                    <div class="dropdown-list" id="provinceList"></div>
                                </div>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="city" class="form-label">شهر</label>
                                <div class="custom-dropdown">
                                    <input type="text" id="city" class="form-control" placeholder="جستجو یا انتخاب شهر" disabled>
                                    <div class="dropdown-list" id="cityList"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="address" class="form-label">آدرس کامل</label>
                        <textarea id="address" class="form-control" rows="3" placeholder="آدرس کامل پستی شامل خیابان، کوچه، پلاک، واحد"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="postalCode" class="form-label">کد پستی</label>
                        <input type="text" id="postalCode" class="form-control" placeholder="کد پستی ۱۰ رقمی">
                        <p class="form-hint">لطفا کد پستی را با اعداد انگلیسی وارد کنید.</p>
                    </div>
                    <div class="form-group">
                        <label for="orderNotes" class="form-label">توضیحات سفارش (اختیاری)</label>
                        <textarea id="orderNotes" class="form-control" rows="2" placeholder="توضیحات اضافی درباره سفارش"></textarea>
                    </div>
                </div>
            </div>
            
            <div class="checkout-form-container" id="shippingMethodForm">
                <div class="checkout-form">
                    <h3 style="margin-bottom: 15px; color: var(--dark);">روش ارسال را انتخاب کنید</h3>
                    <div class="shipping-methods">
                        <label class="shipping-method selected" for="shippingMethod1">
                            <input type="radio" id="shippingMethod1" name="shippingMethod" value="post" checked>
                            <div class="shipping-method-content">
                                <div class="shipping-method-title">پست پیشتاز</div>
                                <div class="shipping-method-desc">تحویل بین ۳ تا ۷ روز کاری</div>
                            </div>
                            <div class="shipping-method-price">۵۵,۰۰۰ تومان</div>
                        </label>
                        <label class="shipping-method" for="shippingMethod2">
                            <input type="radio" id="shippingMethod2" name="shippingMethod" value="mahax">
                            <div class="shipping-method-content">
                                <div class="shipping-method-title">ماهکس (پس کرایه)</div>
                                <div class="shipping-method-desc">تحویل بین ۱ تا ۲ روز کاری</div>
                            </div>
                            <div class="shipping-method-price">پس کرایه</div>
                        </label>
                    </div>
                </div>
                <div class="order-summary">
                    <div class="order-summary-title">خلاصه سفارش</div>
                    <div class="order-summary-item">
                        <span>جمع سبد خرید:</span>
                        <span id="checkoutCartTotal">۰ تومان</span>
                    </div>
                    <div class="order-summary-item">
                        <span>هزینه ارسال:</span>
                        <span id="checkoutShippingCost">۰ تومان</span>
                    </div>
                    <div class="order-summary-item order-summary-total">
                        <span>جمع کل:</span>
                        <span id="checkoutFinalTotal">۰ تومان</span>
                    </div>
                </div>
            </div>
            
            <div class="checkout-form-container" id="paymentForm">
                <div class="checkout-form">
                    <h3 style="margin-bottom: 15px; color: var(--dark);">پرداخت سفارش</h3>
                    <div class="payment-info">
                        <div class="payment-info-title">اطلاعات پرداخت</div>
                        <div class="payment-info-details">
                            <p>لطفاً مبلغ <strong id="paymentAmount">۰ تومان</strong> را به شماره کارت زیر واریز نمایید:</p>
                            <p class="card-number" onclick="copyCardNumber('6219861902731925')">۶۲۱۹۸۶۱۹۰۲۷۳۱۹۲۵</p>
                            <p>به نام: احسان بهبودنیا (بانک سامان)</p>
                        </div>
                    </div>
                    <div class="file-upload">
                        <label class="file-upload-label">تصویر فیش واریزی</label>
                        <input type="file" id="receiptImage" class="file-upload-input" accept="image/*">
                        <label for="receiptImage" class="file-upload-button">
                            <i class="fas fa-upload"></i>
                            <span class="file-name" id="fileName">فایلی انتخاب نشده</span>
                            <i class="fas fa-check-circle"></i>
                        </label>
                    </div>
                    <div class="order-review">
                        <div class="order-review-title">بررسی نهایی سفارش</div>
                        <div id="reviewItemsContainer"></div>
                        <div class="order-review-item">
                            <div class="order-review-label">نام گیرنده:</div>
                            <div class="order-review-value" id="reviewFullName">-</div>
                        </div>
                        <div class="order-review-item">
                            <div class="order-review-label">شماره تماس:</div>
                            <div class="order-review-value" id="reviewPhoneNumber">-</div>
                        </div>
                        <div class="order-review-item">
                            <div class="order-review-label">آدرس:</div>
                            <div class="order-review-value" id="reviewAddress">-</div>
                        </div>
                        <div class="order-review-item">
                            <div class="order-review-label">روش ارسال:</div>
                            <div class="order-review-value" id="reviewShippingMethod">-</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="checkout-form-container" id="orderConfirmation">
                <div class="order-confirmation">
                    <div class="order-confirmation-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h2 class="order-confirmation-title">سفارش شما با موفقیت ثبت شد!</h2>
                    <p class="order-confirmation-message">
                        سفارش شما با شماره <strong id="orderNumber"></strong> ثبت شد.<br>
                        همکاران ما در اسرع وقت سفارش شما را پردازش خواهند کرد.
                    </p>
                    <button class="btn btn-primary" id="closeCheckoutAfterConfirm">بازگشت به فروشگاه</button>
                </div>
            </div>
        </div>

        <div class="side-modal-footer" id="checkoutFooter">
             <div class="checkout-actions">
                <button class="btn btn-secondary" id="checkoutBackButton" style="display: none;">مرحله قبل</button>
                <button class="btn btn-primary" id="checkoutNextButton">مرحله بعد</button>
            </div>
        </div>
    </div>
    
    <div class="side-modal" id="wishlistModal">
        <div class="side-modal-header">
            <h3 class="side-modal-title">لیست علاقه‌مندی‌ها</h3>
            <button class="close-side-modal" id="closeWishlist">&times;</button>
        </div>
        <div class="side-modal-body" id="wishlistItems">
            <!-- Wishlist items will be populated here -->
        </div>
    </div>
    
    <div class="modal" id="productModal">
        <div class="modal-content">
            <button class="close-modal-btn" id="closeProductModal">&times;</button>
            <div class="product-detail-container" id="productDetailContent"></div>
        </div>
    </div>

    <div class="modal" id="sizeModal">
        <div class="modal-content">
            <button class="close-modal-btn" id="closeSizeModal">&times;</button>
            <h3 class="size-modal-title" id="sizeModalTitle">انتخاب حجم</h3>
            <div class="size-options-modal" id="sizeOptions"></div>
            <button class="add-to-cart-size" id="addToCartSize">افزودن به سبد خرید</button>
        </div>
    </div>

    <div class="modal" id="profileModal">
        <div class="modal-content">
            <button class="close-modal-btn" id="closeProfileModal">&times;</button>
            <h2>پروفایل کاربری</h2>
            <div class="profile-info" id="profileInfoBody">
                <!-- Profile info will be populated here -->
            </div>
        </div>
    </div>

    <div class="modal" id="ordersModal">
        <div class="modal-content">
            <button class="close-modal-btn" id="closeOrdersModal">&times;</button>
            <h2>سفارش‌های من</h2>
            <div class="orders-list" id="ordersListBody">
                <!-- Orders list will be populated here -->
            </div>
        </div>
    </div>
    
    <div class="overlay" id="overlay"></div>
    
    <div class="toast" id="toast"></div>

    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    
    <script>
        // --- START: CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyA-5z_1keyBEMxW-iA2WQK4fAznG10uQ78",
            authDomain: "hamsarperfume-83cb6.firebaseapp.com",
            projectId: "hamsarperfume-83cb6",
            storageBucket: "hamsarperfume-83cb6.appspot.com",
            messagingSenderId: "926272445971",
            appId: "1:926272445971:web:051c76a5ed4af23f1e29e6",
            measurementId: "G-G7QCTQXB8C"
        };

        const emailJsConfig = {
            serviceID: 'service_93422fg',
            templateID: 'template_d6wdpb4',
            publicKey: 'xluvNfOZ9_o0SFRVi'
        };

        const imgbbApiKey = 'de55bc5b6525015fc1ef403f5adbb2f9';
        // --- END: CONFIGURATION ---

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // Initialize EmailJS
        emailjs.init(emailJsConfig.publicKey);
        
        // --- START: Perfume Data ---
        const perfumes = [
            // ... (perfume data remains the same as in your original file)
            // I'm omitting this section for brevity, but it should be copied from your original file
        ];
        // --- END: Perfume Data ---

        // --- START: Provinces and Cities Data ---
        const iranData = {
            // ... (provinces and cities data remains the same as in your original file)
            // I'm omitting this section for brevity, but it should be copied from your original file
        };
        // --- END: Provinces and Cities Data ---

        // --- START: Global State & Variables ---
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        let wishlist = JSON.parse(localStorage.getItem('wishlist')) || [];
        let selectedPerfume = null;
        let selectedSize = null;
        let currentUser = null;
        let userIsAdmin = false;
        let currentCheckoutStep = 1;
        let receiptFile = null;
        let startY = 0;
        let currentY = 0;
        // --- END: Global State & Variables ---

        // --- START: DOM Element caching ---
        const DOMElements = {
            body: document.body,
            overlay: document.getElementById('overlay'),
            toast: document.getElementById('toast'),
            hamburger: document.getElementById('hamburger'),
            mobileMenu: document.getElementById('mobileMenu'),
            pullToRefresh: document.getElementById('pullToRefresh'),

            menPerfumes: document.getElementById('menPerfumes'),
            womenPerfumes: document.getElementById('womenPerfumes'),
            unisexPerfumes: document.getElementById('unisexPerfumes'),

            cartIcon: document.getElementById('cartIcon'),
            cartModal: document.getElementById('cartModal'),
            closeCart: document.getElementById('closeCart'),
            cartItems: document.getElementById('cartItems'),
            cartTotal: document.getElementById('cartTotal'),
            cartCount: document.getElementById('cartCount'),
            mobileCartCount: document.getElementById('mobileCartCount'),
            
            wishlistIcon: document.getElementById('wishlistIcon'),
            wishlistModal: document.getElementById('wishlistModal'),
            closeWishlist: document.getElementById('closeWishlist'),
            wishlistItems: document.getElementById('wishlistItems'),
            wishlistCount: document.getElementById('wishlistCount'),
            mobileWishlistCount: document.getElementById('mobileWishlistCount'),

            productModal: document.getElementById('productModal'),
            closeProductModal: document.getElementById('closeProductModal'),
            productDetailContent: document.getElementById('productDetailContent'),

            sizeModal: document.getElementById('sizeModal'),
            closeSizeModal: document.getElementById('closeSizeModal'),
            sizeModalTitle: document.getElementById('sizeModalTitle'),
            sizeOptions: document.getElementById('sizeOptions'),
            addToCartSize: document.getElementById('addToCartSize'),

            searchIcon: document.getElementById('searchIcon'),
            searchHeader: document.getElementById('searchHeader'),
            closeSearch: document.getElementById('closeSearch'),
            searchInput: document.getElementById('searchInput'),
            searchResults: document.getElementById('searchResults'),
            
            // Authentication
            authModal: document.getElementById('authModal'),
            closeAuthModal: document.getElementById('closeAuthModal'),
            loginBtn: document.getElementById('loginBtn'),
            userDropdown: document.getElementById('userDropdown'),
            userAvatar: document.getElementById('userAvatar'),
            profileLink: document.getElementById('profileLink'),
            ordersLink: document.getElementById('ordersLink'),
            adminLink: document.getElementById('adminLink'),
            logoutLink: document.getElementById('logoutLink'),
            authTabs: document.querySelectorAll('.auth-tab'),
            loginForm: document.getElementById('loginForm'),
            registerForm: document.getElementById('registerForm'),
            loginButton: document.getElementById('loginButton'),
            registerButton: document.getElementById('registerButton'),
            showRegister: document.getElementById('showRegister'),
            showLogin: document.getElementById('showLogin'),
            googleLogin: document.getElementById('googleLogin'),
            googleRegister: document.getElementById('googleRegister'),
            mobileProfile: document.getElementById('mobileProfile'),
            mobileOrders: document.getElementById('mobileOrders'),
            mobileLogout: document.getElementById('mobileLogout'),
            mobileLogin: document.getElementById('mobileLogin'),

            // Profile & Orders Modals
            profileModal: document.getElementById('profileModal'),
            closeProfileModal: document.getElementById('closeProfileModal'),
            profileInfoBody: document.getElementById('profileInfoBody'),
            ordersModal: document.getElementById('ordersModal'),
            closeOrdersModal: document.getElementById('closeOrdersModal'),
            ordersListBody: document.getElementById('ordersListBody'),
            
            // Checkout
            checkoutModal: document.getElementById('checkoutModal'),
            closeCheckout: document.getElementById('closeCheckout'),
            checkoutButton: document.getElementById('checkoutButton'),
            checkoutFooter: document.getElementById('checkoutFooter'),
            checkoutBackButton: document.getElementById('checkoutBackButton'),
            checkoutNextButton: document.getElementById('checkoutNextButton'),

            stepNodes: [document.getElementById('stepNode1'), document.getElementById('stepNode2'), document.getElementById('stepNode3')],
            checkoutProgress: document.getElementById('checkoutProgress'),
            
            formContainers: {
                shippingInfo: document.getElementById('shippingInfoForm'),
                shippingMethod: document.getElementById('shippingMethodForm'),
                payment: document.getElementById('paymentForm'),
                confirmation: document.getElementById('orderConfirmation'),
            },
            
            shippingForm: {
                fullName: document.getElementById('fullName'),
                phoneNumber: document.getElementById('phoneNumber'),
                province: document.getElementById('province'),
                provinceList: document.getElementById('provinceList'),
                city: document.getElementById('city'),
                cityList: document.getElementById('cityList'),
                address: document.getElementById('address'),
                postalCode: document.getElementById('postalCode'),
                orderNotes: document.getElementById('orderNotes'),
            },

            shippingMethodRadios: document.querySelectorAll('input[name="shippingMethod"]'),
            
            checkoutTotals: {
                cart: document.getElementById('checkoutCartTotal'),
                shipping: document.getElementById('checkoutShippingCost'),
                final: document.getElementById('checkoutFinalTotal'),
            },
            
            paymentInfo: {
                amount: document.getElementById('paymentAmount'),
                receiptImage: document.getElementById('receiptImage'),
                fileName: document.getElementById('fileName'),
                fileUploadButton: document.querySelector('.file-upload-button'),
            },

            reviewInfo: {
                itemsContainer: document.getElementById('reviewItemsContainer'),
                fullName: document.getElementById('reviewFullName'),
                phoneNumber: document.getElementById('reviewPhoneNumber'),
                address: document.getElementById('reviewAddress'),
                shippingMethod: document.getElementById('reviewShippingMethod'),
            },
            
            orderConfirmation: {
                number: document.getElementById('orderNumber'),
                closeButton: document.getElementById('closeCheckoutAfterConfirm'),
            }
        };
        // --- END: DOM Element caching ---

        // --- START: Utility Functions ---
        const formatPrice = (price) => `${parseInt(price).toLocaleString('fa-IR')} تومان`;
        
        const showToast = (message, type = 'normal') => {
            const toast = DOMElements.toast;
            toast.textContent = message;
            toast.className = `toast show ${type}`;
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        };
        
        const openModal = (modal) => {
            modal.classList.add('active');
            DOMElements.overlay.classList.add('active');
            DOMElements.body.classList.add('modal-open');
        };

        const closeModal = (modal) => {
            modal.classList.remove('active');
            const anyModalActive = document.querySelector('.modal.active, .side-modal.open');
            if (!anyModalActive) {
                DOMElements.overlay.classList.remove('active');
                DOMElements.body.classList.remove('modal-open');
            }
        };

        const openSideModal = (modal) => {
            modal.classList.add('open');
            DOMElements.overlay.classList.add('active');
            DOMElements.body.classList.add('modal-open');
        };

        const closeSideModal = (modal) => {
            modal.classList.remove('open');
            const anyModalActive = document.querySelector('.modal.active, .side-modal.open');
            if (!anyModalActive) {
                DOMElements.overlay.classList.remove('active');
                DOMElements.body.classList.remove('modal-open');
            }
        };

        const copyCardNumber = (cardNumber) => {
            navigator.clipboard.writeText(cardNumber).then(() => {
                showToast('شماره کارت در کلیپ‌بورد کپی شد', 'success');
            }).catch(err => {
                showToast('خطا در کپی کردن شماره کارت');
            });
        };
        // --- END: Utility Functions ---

        // --- START: Product & UI Rendering ---
        const generateProductCards = () => {
            DOMElements.menPerfumes.innerHTML = '';
            DOMElements.womenPerfumes.innerHTML = '';
            DOMElements.unisexPerfumes.innerHTML = '';
            
            perfumes.forEach(perfume => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card will-change';
                const basePrice = perfume.sizes[0].price;
                const isInWishlist = wishlist.some(item => item.id === perfume.id);
                
                productCard.innerHTML = `
                    <div class="product-image">
                        <img src="${perfume.image}" alt="${perfume.name}" loading="lazy">
                        ${perfume.badge ? `<span class="product-badge">${perfume.badge}</span>` : ''}
                    </div>
                    <div class="product-info">
                        <h3 class="product-title">${perfume.name}</h3>
                        <div class="product-bottom">
                            <div class="product-price">${formatPrice(basePrice)}</div>
                            <div class="product-actions">
                                <button class="action-btn wishlist-btn ${isInWishlist ? 'active' : ''}" aria-label="افزودن به علاقه‌مندی‌ها">
                                    <i class="${isInWishlist ? 'fas' : 'far'} fa-heart"></i>
                                </button>
                                <button class="action-btn add-to-cart-btn" aria-label="افزودن به سبد خرید">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>`;
                
                productCard.querySelector('.add-to-cart-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    openSizeModal(perfume);
                });
                
                const wishlistBtn = productCard.querySelector('.wishlist-btn');
                wishlistBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleWishlist(perfume, wishlistBtn);
                });
                
                productCard.addEventListener('click', () => showProductDetails(perfume));
                
                // Add swipe functionality for mobile
                setupSwipeActions(productCard, perfume);
                
                const container = perfume.category === 'men' ? DOMElements.menPerfumes :
                                  perfume.category === 'women' ? DOMElements.womenPerfumes :
                                  DOMElements.unisexPerfumes;
                container.appendChild(productCard);
            });
        };

        const setupSwipeActions = (productCard, perfume) => {
            let startX = 0;
            let currentX = 0;
            let isSwiping = false;
            
            productCard.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
                isSwiping = true;
            });
            
            productCard.addEventListener('touchmove', (e) => {
                if (!isSwiping) return;
                currentX = e.touches[0].clientX;
                const diff = startX - currentX;
                
                if (diff > 50) {
                    // Swipe left - add to cart
                    productCard.classList.add('swipe-left');
                } else if (diff < -50) {
                    // Swipe right - add to wishlist
                    productCard.classList.add('swipe-right');
                }
            });
            
            productCard.addEventListener('touchend', (e) => {
                if (!isSwiping) return;
                const diff = startX - currentX;
                
                if (diff > 50) {
                    // Swipe left - add to cart
                    openSizeModal(perfume);
                } else if (diff < -50) {
                    // Swipe right - add to wishlist
                    const wishlistBtn = productCard.querySelector('.wishlist-btn');
                    toggleWishlist(perfume, wishlistBtn);
                }
                
                // Reset
                productCard.classList.remove('swipe-left', 'swipe-right');
                isSwiping = false;
            });
        };

        const showProductDetails = (perfume) => {
            let sizeOptionsHTML = perfume.sizes.map(size => `
                <div class="size-option-detail" data-size="${size.size}" data-price="${size.price}">
                    <span>${size.size}</span>
                    <span class="size-price">${formatPrice(size.price)}</span>
                </div>
            `).join('');
            
            let specsHTML = Object.entries(perfume.specs).map(([key, value]) => `
                <div class="spec-item">
                    <div class="spec-title">${key}:</div>
                    <div class="spec-value">${value}</div>
                </div>
            `).join('');

            const isInWishlist = wishlist.some(item => item.id === perfume.id);
            
            DOMElements.productDetailContent.innerHTML = `
                <div class="product-detail-image">
                    <img src="${perfume.image}" alt="${perfume.name}">
                </div>
                <div class="product-detail-info">
                    <h2 class="product-detail-title">${perfume.name}</h2>
                    <div class="product-detail-price">${formatPrice(perfume.sizes[0].price)}</div>
                    <div class="product-detail-description"><p>${perfume.description}</p></div>
                    <div class="product-detail-specs">${specsHTML}</div>
                    <div class="product-detail-sizes">
                        <h3>حجم محصول:</h3>
                        <div class="size-grid">${sizeOptionsHTML}</div>
                    </div>
                    <div class="product-detail-actions">
                        <button class="add-to-cart-detail touch-target">
                            <i class="fas fa-shopping-cart"></i> افزودن به سبد خرید
                        </button>
                        <button class="wishlist-btn-detail touch-target ${isInWishlist ? 'active' : ''}">
                            <i class="${isInWishlist ? 'fas' : 'far'} fa-heart"></i>
                        </button>
                    </div>
                </div>`;

            const sizeOptions = DOMElements.productDetailContent.querySelectorAll('.size-option-detail');
            const priceElement = DOMElements.productDetailContent.querySelector('.product-detail-price');
            let selectedDetailSize = null;

            sizeOptions.forEach(option => {
                option.addEventListener('click', () => {
                    sizeOptions.forEach(opt => opt.classList.remove('active'));
                    option.classList.add('active');
                    priceElement.textContent = formatPrice(option.dataset.price);
                    selectedDetailSize = { size: option.dataset.size, price: parseInt(option.dataset.price) };
                });
            });

            DOMElements.productDetailContent.querySelector('.add-to-cart-detail').addEventListener('click', () => {
                if (selectedDetailSize) {
                    addToCart(perfume, selectedDetailSize.size, selectedDetailSize.price);
                } else if (perfume.sizes.length === 1) {
                    addToCart(perfume, perfume.sizes[0].size, perfume.sizes[0].price);
                } else {
                    showToast('لطفاً حجم مورد نظر را انتخاب کنید');
                }
            });
            
            const wishlistBtn = DOMElements.productDetailContent.querySelector('.wishlist-btn-detail');
            wishlistBtn.addEventListener('click', () => toggleWishlist(perfume, wishlistBtn));
            
            openModal(DOMElements.productModal);
        };
        // --- END: Product & UI Rendering ---

        // --- START: Cart & Wishlist Logic ---
        const saveToLocalStorage = (key, data) => localStorage.setItem(key, JSON.stringify(data));
        
        const updateCartCount = () => {
            const count = cart.reduce((sum, item) => sum + item.quantity, 0);
            DOMElements.cartCount.textContent = count;
            DOMElements.mobileCartCount.textContent = count;
        };
        
        const updateWishlistCount = () => {
            const count = wishlist.length;
            DOMElements.wishlistCount.textContent = count;
            DOMElements.mobileWishlistCount.textContent = count;
        };

        const addToCart = (perfume, size, price) => {
            const existingItem = cart.find(item => item.id === perfume.id && item.size === size);
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({ id: perfume.id, name: perfume.name, size, price, image: perfume.image, quantity: 1 });
            }
            saveToLocalStorage('cart', cart);
            updateCartCount();
            updateCartUI();
            showToast(`${perfume.name} به سبد خرید اضافه شد!`, 'success');
        };

        const toggleWishlist = (perfume, button) => {
            const index = wishlist.findIndex(item => item.id === perfume.id);
            if (index === -1) {
                wishlist.push({ id: perfume.id, name: perfume.name, price: perfume.price, image: perfume.image });
                showToast('به لیست علاقه‌مندی‌ها اضافه شد');
                button.innerHTML = '<i class="fas fa-heart"></i>';
                button.classList.add('active');
            } else {
                wishlist.splice(index, 1);
                showToast('از لیست علاقه‌مندی‌ها حذف شد');
                button.innerHTML = '<i class="far fa-heart"></i>';
                button.classList.remove('active');
            }
            saveToLocalStorage('wishlist', wishlist);
            updateWishlistCount();
            // Also update the icon on the main product grid
            const gridButton = document.querySelector(`.product-card .wishlist-btn[data-id='${perfume.id}']`);
            if (gridButton) {
                gridButton.innerHTML = button.innerHTML;
                gridButton.classList.toggle('active', index === -1);
            }
        };

        const updateCartUI = () => {
            if (cart.length === 0) {
                DOMElements.cartItems.innerHTML = '<div style="text-align: center; padding: 30px; color: #777;">سبد خرید شما خالی است</div>';
                DOMElements.cartTotal.textContent = formatPrice(0);
                DOMElements.checkoutButton.disabled = true;
                return;
            }

            DOMElements.checkoutButton.disabled = false;
            let total = 0;
            DOMElements.cartItems.innerHTML = '';
            cart.forEach((item, index) => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                const cartItemEl = document.createElement('div');
                cartItemEl.className = 'cart-item';
                cartItemEl.innerHTML = `
                    <div class="cart-item-image"><img src="${item.image}" alt="${item.name}"></div>
                    <div class="cart-item-details">
                        <div class="cart-item-name">${item.name}</div>
                        <div class="cart-item-size">حجم: ${item.size}</div>
                        <div class="cart-item-price">${formatPrice(itemTotal)}</div>
                    </div>
                    <button class="cart-item-remove" data-index="${index}" aria-label="حذف محصول"><i class="fas fa-trash"></i></button>`;
                DOMElements.cartItems.appendChild(cartItemEl);
            });

            DOMElements.cartTotal.textContent = formatPrice(total);
            document.querySelectorAll('.cart-item-remove').forEach(button => {
                button.addEventListener('click', () => {
                    const index = parseInt(button.dataset.index);
                    cart.splice(index, 1);
                    saveToLocalStorage('cart', cart);
                    updateCartCount();
                    updateCartUI();
                });
            });
        };

        const updateWishlistUI = () => {
             if (wishlist.length === 0) {
                DOMElements.wishlistItems.innerHTML = '<div style="text-align: center; padding: 30px; color: #777;">لیست علاقه‌مندی‌های شما خالی است</div>';
                return;
            }
            DOMElements.wishlistItems.innerHTML = '';
            wishlist.forEach((item, index) => {
                const wishlistItemEl = document.createElement('div');
                wishlistItemEl.className = 'cart-item';
                wishlistItemEl.innerHTML = `
                    <div class="cart-item-image"><img src="${item.image}" alt="${item.name}"></div>
                    <div class="cart-item-details">
                        <div class="cart-item-name">${item.name}</div>
                        <div class="cart-item-price">${formatPrice(item.price)}</div>
                    </div>
                    <button class="cart-item-remove" data-index="${index}" aria-label="حذف محصول"><i class="fas fa-trash"></i></button>`;
                DOMElements.wishlistItems.appendChild(wishlistItemEl);
            });
            document.querySelectorAll('#wishlistItems .cart-item-remove').forEach(button => {
                button.addEventListener('click', () => {
                    const index = parseInt(button.dataset.index);
                    const removedPerfumeId = wishlist[index].id;
                    wishlist.splice(index, 1);
                    saveToLocalStorage('wishlist', wishlist);
                    updateWishlistCount();
                    updateWishlistUI();
                    // Update main grid view
                    generateProductCards();
                });
            });
        };
        
        const openSizeModal = (perfume) => {
            selectedPerfume = perfume;
            selectedSize = null;
            DOMElements.sizeModalTitle.textContent = perfume.name;
            DOMElements.sizeOptions.innerHTML = '';
            
            perfume.sizes.forEach(size => {
                const sizeOption = document.createElement('div');
                sizeOption.className = 'size-option-modal';
                sizeOption.dataset.size = size.size;
                sizeOption.dataset.price = size.price;
                sizeOption.innerHTML = `<span>${size.size}</span><span class="size-price-modal">${formatPrice(size.price)}</span>`;
                sizeOption.addEventListener('click', () => {
                    document.querySelectorAll('.size-option-modal').forEach(opt => opt.classList.remove('active'));
                    sizeOption.classList.add('active');
                    selectedSize = size;
                });
                DOMElements.sizeOptions.appendChild(sizeOption);
            });
            openModal(DOMElements.sizeModal);
        };
        // --- END: Cart & Wishlist Logic ---

        // --- START: Authentication ---
        const handleAuthStateChanged = (user) => {
            if (user) {
                currentUser = user;
                DOMElements.loginBtn.style.display = 'none';
                DOMElements.userDropdown.style.display = 'block';
                DOMElements.mobileLogin.style.display = 'none';
                DOMElements.mobileProfile.style.display = 'flex';
                DOMElements.mobileOrders.style.display = 'flex';
                DOMElements.mobileLogout.style.display = 'flex';
                DOMElements.userAvatar.src = user.photoURL || `https://ui-avatars.com/api/?name=${user.displayName || user.email}&background=random&color=fff`;

                // Check for admin custom claim
                user.getIdTokenResult().then((idTokenResult) => {
                    userIsAdmin = !!idTokenResult.claims.admin;
                    DOMElements.adminLink.style.display = userIsAdmin ? 'flex' : 'none';
                });
                
                closeModal(DOMElements.authModal);
            } else {
                currentUser = null;
                userIsAdmin = false;
                DOMElements.loginBtn.style.display = 'block';
                DOMElements.userDropdown.style.display = 'none';
                DOMElements.adminLink.style.display = 'none';
                DOMElements.mobileLogin.style.display = 'flex';
                DOMElements.mobileProfile.style.display = 'none';
                DOMElements.mobileOrders.style.display = 'none';
                DOMElements.mobileLogout.style.display = 'none';
            }
        };

        const signOut = () => {
            auth.signOut().then(() => showToast('با موفقیت خارج شدید')).catch(error => showToast('خطا در خروج: ' + error.message));
        };
        
        const setupAuthEventListeners = () => {
            DOMElements.loginButton.addEventListener('click', () => {
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                if (!email || !password) return showToast('لطفاً ایمیل و رمز عبور را وارد کنید');
                auth.signInWithEmailAndPassword(email, password)
                    .catch(error => showToast(`خطا در ورود: ${error.code === 'auth/invalid-credential' ? 'ایمیل یا رمز عبور اشتباه است' : error.message}`));
            });

            DOMElements.registerButton.addEventListener('click', () => {
                const name = document.getElementById('registerName').value.trim();
                const phone = document.getElementById('registerPhone').value.trim();
                const email = document.getElementById('registerEmail').value.trim();
                const password = document.getElementById('registerPassword').value;
                const confirmPassword = document.getElementById('registerConfirmPassword').value;

                if (!name || !phone || !email || !password) return showToast('لطفاً تمام فیلدها را پر کنید');
                if (password !== confirmPassword) return showToast('رمز عبور و تکرار آن مطابقت ندارند');
                if (password.length < 6) return showToast('رمز عبور باید حداقل ۶ کاراکتر باشد');
                if (!/^[0-9۰-۹+()\s-]{10,}$/.test(phone)) return showToast('لطفاً شماره تماس معتبر وارد کنید');

                auth.createUserWithEmailAndPassword(email, password)
                    .then(userCredential => {
                        return userCredential.user.updateProfile({ displayName: name }).then(() => {
                           // Store phone in Firestore as it's not natively supported in Auth profile for email provider
                           return db.collection('users').doc(userCredential.user.uid).set({
                               name: name,
                               phone: phone,
                               email: email
                           });
                        });
                    })
                    .then(() => {
                        showToast('حساب کاربری با موفقیت ایجاد شد! اکنون وارد شوید.');
                        DOMElements.authTabs[0].click(); // Switch to login tab
                    })
                    .catch(error => showToast(`خطا در ثبت‌نام: ${error.code === 'auth/email-already-in-use' ? 'این ایمیل قبلا استفاده شده' : error.message}`));
            });
            
            const handleGoogleSignIn = () => {
                const provider = new firebase.auth.GoogleAuthProvider();
                auth.signInWithPopup(provider).catch(error => showToast('خطا در ورود با گوگل: ' + error.message));
            };
            DOMElements.googleLogin.addEventListener('click', handleGoogleSignIn);
            DOMElements.googleRegister.addEventListener('click', handleGoogleSignIn);
        };
        // --- END: Authentication ---

        // --- START: Profile & Orders Modals Logic ---
        const setupUserModals = () => {
            DOMElements.profileLink.addEventListener('click', () => {
                DOMElements.profileInfoBody.innerHTML = `<p>نام: ${currentUser.displayName || 'ثبت نشده'}</p><p>ایمیل: ${currentUser.email}</p>`;
                openModal(DOMElements.profileModal);
            });
            DOMElements.mobileProfile.addEventListener('click', () => DOMElements.profileLink.click());

            DOMElements.ordersLink.addEventListener('click', () => {
                if(!currentUser) return;
                DOMElements.ordersListBody.innerHTML = '<p>در حال بارگذاری سفارش‌ها...</p>';
                openModal(DOMElements.ordersModal);

                db.collection('orders').where('userId', '==', currentUser.uid).orderBy('createdAt', 'desc').get()
                    .then(snapshot => {
                        if (snapshot.empty) {
                            DOMElements.ordersListBody.innerHTML = '<p>شما تاکنون سفارشی ثبت نکرده‌اید.</p>';
                            return;
                        }
                        let ordersHTML = '';
                        snapshot.forEach(doc => {
                            const order = doc.data();
                            const statusClasses = { pending: 'pending', shipped: 'shipped', delivered: 'delivered', cancelled: 'cancelled' };
                            const statusTexts = { pending: 'در انتظار', shipped: 'ارسال شده', delivered: 'تحویل شده', cancelled: 'لغو شده' };
                            ordersHTML += `
                                <div class="order-item">
                                    <div class="order-item-header">
                                        <span>شماره سفارش: ${order.orderNumber}</span>
                                        <span class="order-status ${statusClasses[order.status] || 'pending'}">${statusTexts[order.status] || 'نامشخص'}</span>
                                    </div>
                                    <p>تاریخ: ${new Date(order.createdAt.seconds * 1000).toLocaleDateString('fa-IR')}</p>
                                    <p>مبلغ کل: ${formatPrice(order.total)}</p>
                                </div>`;
                        });
                        DOMElements.ordersListBody.innerHTML = ordersHTML;
                    }).catch(err => {
                        DOMElements.ordersListBody.innerHTML = '<p>خطا در دریافت سفارش‌ها.</p>';
                        console.error(err);
                    });
            });
            DOMElements.mobileOrders.addEventListener('click', () => DOMElements.ordersLink.click());
        };
        // --- END: Profile & Orders Modals Logic ---
        
        // --- START: Checkout Logic ---
        const startCheckout = () => {
            if (cart.length === 0) return showToast('سبد خرید شما خالی است!');
            if (!currentUser) {
                showToast('برای ادامه، لطفاً ابتدا وارد حساب کاربری خود شوید.');
                openModal(DOMElements.authModal);
                return;
            }
            
            // Prefill form
            DOMElements.shippingForm.fullName.value = currentUser.displayName || '';
            db.collection('users').doc(currentUser.uid).get().then(doc => {
                if (doc.exists) DOMElements.shippingForm.phoneNumber.value = doc.data().phone || '';
            });

            currentCheckoutStep = 1;
            updateCheckoutUI();
            closeSideModal(DOMElements.cartModal);
            openSideModal(DOMElements.checkoutModal);
        };
        
        const updateCheckoutUI = () => {
            // Update step indicators
            DOMElements.stepNodes.forEach((stepNode, index) => {
                const stepNum = index + 1;
                stepNode.classList.remove('active', 'completed');
                if (stepNum < currentCheckoutStep) stepNode.classList.add('completed');
                else if (stepNum === currentCheckoutStep) stepNode.classList.add('active');
            });
            
            // Update progress bar
            const progress = currentCheckoutStep <= 1 ? 0 : currentCheckoutStep === 2 ? 50 : 100;
            DOMElements.checkoutProgress.style.width = `${progress}%`;

            // Show/hide form containers
            Object.values(DOMElements.formContainers).forEach(form => form.classList.remove('active'));
            const activeForm = currentCheckoutStep === 1 ? 'shippingInfo' :
                               currentCheckoutStep === 2 ? 'shippingMethod' :
                               currentCheckoutStep === 3 ? 'payment' : 'confirmation';
            if(DOMElements.formContainers[activeForm]) DOMElements.formContainers[activeForm].classList.add('active');

            // Update footer buttons
            DOMElements.checkoutFooter.style.display = currentCheckoutStep > 3 ? 'none' : 'block';
            DOMElements.checkoutBackButton.style.display = currentCheckoutStep > 1 ? 'inline-flex' : 'none';
            DOMElements.checkoutNextButton.textContent = currentCheckoutStep === 3 ? 'تکمیل سفارش و پرداخت' : 'مرحله بعد';
        };

        const handleCheckoutNavigation = (direction) => {
            if (direction === 'next') {
                if (currentCheckoutStep === 1 && !validateShippingInfo()) return;
                if (currentCheckoutStep === 3) {
                    completeOrder();
                    return;
                }
                currentCheckoutStep++;
            } else {
                currentCheckoutStep--;
            }
            if (currentCheckoutStep === 2) prepareShippingMethodStep();
            if (currentCheckoutStep === 3) preparePaymentStep();
            updateCheckoutUI();
        };

        const validateShippingInfo = () => {
            const { fullName, phoneNumber, province, city, address, postalCode } = DOMElements.shippingForm;
            if (!fullName.value.trim()) { showToast('لطفاً نام گیرنده را وارد کنید'); return false; }
            if (!/^[0-9]{11}$/.test(phoneNumber.value)) { showToast('لطفاً شماره تماس ۱۱ رقمی معتبر (انگلیسی) وارد کنید'); return false; }
            if (!province.value.trim()) { showToast('لطفاً استان را انتخاب کنید'); return false; }
            if (!city.value.trim()) { showToast('لطفاً شهر را انتخاب کنید'); return false; }
            if (!address.value.trim()) { showToast('لطفاً آدرس کامل را وارد کنید'); return false; }
            if (!/^[0-9]{10}$/.test(postalCode.value)) { showToast('لطفاً کد پستی ۱۰ رقمی معتبر (انگلیسی) وارد کنید'); return false; }
            return true;
        };

        const calculateTotals = () => {
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const selectedShipping = document.querySelector('input[name="shippingMethod"]:checked').value;
            const shippingCost = selectedShipping === 'post' ? 55000 : 0;
            const finalTotal = subtotal + shippingCost;
            return { subtotal, shippingCost, finalTotal, shippingMethod: selectedShipping === 'post' ? 'پست پیشتاز' : 'ماهکس' };
        };

        const prepareShippingMethodStep = () => {
            const { subtotal, shippingCost, finalTotal } = calculateTotals();
            DOMElements.checkoutTotals.cart.textContent = formatPrice(subtotal);
            DOMElements.checkoutTotals.shipping.textContent = shippingCost > 0 ? formatPrice(shippingCost) : 'پس کرایه';
            DOMElements.checkoutTotals.final.textContent = formatPrice(finalTotal);
        };
        
        const preparePaymentStep = () => {
            const { finalTotal, shippingMethod, subtotal, shippingCost } = calculateTotals();
            DOMElements.paymentInfo.amount.textContent = formatPrice(finalTotal);
            
            // Update review section
            DOMElements.reviewInfo.fullName.textContent = DOMElements.shippingForm.fullName.value;
            DOMElements.reviewInfo.phoneNumber.textContent = DOMElements.shippingForm.phoneNumber.value;
            DOMElements.reviewInfo.address.textContent = `${DOMElements.shippingForm.province.value}، ${DOMElements.shippingForm.city.value}، ${DOMElements.shippingForm.address.value} - کدپستی: ${DOMElements.shippingForm.postalCode.value}`;
            DOMElements.reviewInfo.shippingMethod.textContent = shippingMethod;

            // Update review items
            const itemsHTML = cart.map(item => `<p>${item.name} (${item.size}) - ${formatPrice(item.price)}</p>`).join('');
            DOMElements.reviewInfo.itemsContainer.innerHTML = `<div class="order-review-item"><div class="order-review-label">محصولات:</div><div class="order-review-value">${itemsHTML}</div></div>`;
        };
        
        const uploadReceiptImage = async (file) => {
            if (!file) return null;

            const formData = new FormData();
            formData.append('image', file);

            try {
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${imgbbApiKey}`, {
                    method: 'POST',
                    body: formData,
                });

                const result = await response.json();

                if (result.success) {
                    console.log('ImgBB Upload Success:', result.data.url);
                    return result.data.url;
                } else {
                    console.error('ImgBB Upload Error:', result.error.message);
                    throw new Error(`ImgBB upload failed: ${result.error.message}`);
                }
            } catch (error) {
                console.error('Fetch error during ImgBB upload:', error);
                throw error;
            }
        };

        const completeOrder = async () => {
            if (!receiptFile) return showToast('لطفاً تصویر فیش واریزی را بارگذاری کنید.');
            
            const nextButton = DOMElements.checkoutNextButton;
            nextButton.disabled = true;
            nextButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> در حال ثبت...';
            
            try {
                const receiptUrl = await uploadReceiptImage(receiptFile);
                if (!receiptUrl) throw new Error('Image upload failed');

                const { subtotal, shippingCost, finalTotal, shippingMethod } = calculateTotals();
                const orderNum = 'HP-' + Date.now().toString().slice(-6);

                const templateParams = {
                    name: DOMElements.shippingForm.fullName.value,
                    phone: DOMElements.shippingForm.phoneNumber.value,
                    address: `${DOMElements.shippingForm.province.value}, ${DOMElements.shippingForm.city.value}, ${DOMElements.shippingForm.address.value} - کدپستی: ${DOMElements.shippingForm.postalCode.value}`,
                    shipping: shippingMethod,
                    note: DOMElements.shippingForm.orderNotes.value || 'ندارد',
                    receipt: receiptUrl,
                    order_details: cart.map(item => `${item.name} (${item.size}) - تعداد: ${item.quantity}`).join('\n'),
                    total_price: formatPrice(finalTotal),
                    order_number: orderNum
                };

                await emailjs.send(emailJsConfig.serviceID, emailJsConfig.templateID, templateParams);
                
                const orderData = {
                    orderNumber: orderNum,
                    userId: currentUser.uid,
                    shippingInfo: {
                        name: DOMElements.shippingForm.fullName.value,
                        phone: DOMElements.shippingForm.phoneNumber.value,
                        province: DOMElements.shippingForm.province.value,
                        city: DOMElements.shippingForm.city.value,
                        address: DOMElements.shippingForm.address.value,
                        postalCode: DOMElements.shippingForm.postalCode.value,
                        notes: DOMElements.shippingForm.orderNotes.value,
                    },
                    items: cart,
                    subtotal: subtotal,
                    shippingCost: shippingCost,
                    total: finalTotal,
                    receiptUrl: receiptUrl,
                    status: 'pending', // pending, shipped, delivered, cancelled
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                await db.collection('orders').add(orderData);
                
                DOMElements.orderConfirmation.number.textContent = orderNum;
                currentCheckoutStep = 4;
                updateCheckoutUI();
                
                // Clear cart
                cart = [];
                saveToLocalStorage('cart', cart);
                updateCartCount();
                updateCartUI();
                
            } catch (error) {
                console.error("Order completion error: ", error);
                showToast('خطا در ثبت سفارش. لطفا دوباره تلاش کنید.');
            } finally {
                nextButton.disabled = false;
                nextButton.innerHTML = 'تکمیل سفارش و پرداخت';
            }
        };
        // --- END: Checkout Logic ---

        // --- START: Province/City Dropdown Logic ---
        const setupLocationDropdowns = () => {
            const { province, provinceList, city, cityList } = DOMElements.shippingForm;
            
            const populateDropdown = (listEl, items, inputEl, onSelect) => {
                listEl.innerHTML = '';
                items.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'dropdown-item';
                    div.textContent = item;
                    div.addEventListener('click', () => {
                        inputEl.value = item;
                        listEl.style.display = 'none';
                        if(onSelect) onSelect(item);
                    });
                    listEl.appendChild(div);
                });
            };
            
            province.addEventListener('focus', () => {
                populateDropdown(provinceList, Object.keys(iranData), province, (selectedProvince) => {
                    city.disabled = false;
                    city.value = '';
                    populateDropdown(cityList, iranData[selectedProvince], city);
                });
                provinceList.style.display = 'block';
            });
            
            province.addEventListener('input', () => {
                const query = province.value.toLowerCase();
                const filteredProvinces = Object.keys(iranData).filter(p => p.toLowerCase().includes(query));
                populateDropdown(provinceList, filteredProvinces, province, (selectedProvince) => {
                     city.disabled = false;
                    city.value = '';
                    populateDropdown(cityList, iranData[selectedProvince], city);
                });
            });

            city.addEventListener('focus', () => {
                if(iranData[province.value]) {
                   populateDropdown(cityList, iranData[province.value], city);
                   cityList.style.display = 'block';
                }
            });
            
            city.addEventListener('input', () => {
                 if(iranData[province.value]) {
                    const query = city.value.toLowerCase();
                    const filteredCities = iranData[province.value].filter(c => c.toLowerCase().includes(query));
                    populateDropdown(cityList, filteredCities, city);
                 }
            });

            document.addEventListener('click', (e) => {
                if (!province.parentElement.contains(e.target)) provinceList.style.display = 'none';
                if (!city.parentElement.contains(e.target)) cityList.style.display = 'none';
            });
        };
        // --- END: Province/City Dropdown Logic ---
        
        // --- START: Event Listeners ---
        const setupEventListeners = () => {
            // Modals and Overlay
            DOMElements.overlay.addEventListener('click', () => {
                document.querySelectorAll('.modal.active, .side-modal.open').forEach(m => {
                    closeModal(m);
                    closeSideModal(m);
                });
                if(DOMElements.mobileMenu.classList.contains('active')){
                    DOMElements.hamburger.classList.remove('active');
                    DOMElements.mobileMenu.classList.remove('active');
                }
                DOMElements.overlay.classList.remove('active');
                DOMElements.body.classList.remove('modal-open');
            });

            // Hamburger Menu
            DOMElements.hamburger.addEventListener('click', () => {
                DOMElements.hamburger.classList.toggle('active');
                DOMElements.mobileMenu.classList.toggle('active');
                DOMElements.overlay.classList.toggle('active');
                DOMElements.body.classList.toggle('modal-open', DOMElements.mobileMenu.classList.contains('active'));
            });
            document.querySelectorAll('.close-mobile-menu').forEach(link => {
                link.addEventListener('click', () => {
                    DOMElements.hamburger.classList.remove('active');
                    DOMElements.mobileMenu.classList.remove('active');
                    DOMElements.overlay.classList.remove('active');
                    DOMElements.body.classList.remove('modal-open');
                });
            });
            
            // Side Modals (Cart, Wishlist)
            DOMElements.cartIcon.addEventListener('click', () => { updateCartUI(); openSideModal(DOMElements.cartModal); });
            DOMElements.wishlistIcon.addEventListener('click', () => { updateWishlistUI(); openSideModal(DOMElements.wishlistModal); });
            DOMElements.closeCart.addEventListener('click', () => closeSideModal(DOMElements.cartModal));
            DOMElements.closeWishlist.addEventListener('click', () => closeSideModal(DOMElements.wishlistModal));
            
            // Regular Modals
            DOMElements.closeProductModal.addEventListener('click', () => closeModal(DOMElements.productModal));
            DOMElements.closeSizeModal.addEventListener('click', () => closeModal(DOMElements.sizeModal));
            DOMElements.closeAuthModal.addEventListener('click', () => closeModal(DOMElements.authModal));
            DOMElements.closeProfileModal.addEventListener('click', () => closeModal(DOMElements.profileModal));
            DOMElements.closeOrdersModal.addEventListener('click', () => closeModal(DOMElements.ordersModal));

            // Size Modal
            DOMElements.addToCartSize.addEventListener('click', () => {
                if (!selectedPerfume || !selectedSize) return showToast('لطفاً حجم مورد نظر را انتخاب کنید');
                addToCart(selectedPerfume, selectedSize.size, selectedSize.price);
                closeModal(DOMElements.sizeModal);
            });

            // Auth Tabs
            DOMElements.authTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    DOMElements.authTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    DOMElements.loginForm.classList.toggle('active', tab.dataset.tab === 'login');
                    DOMElements.registerForm.classList.toggle('active', tab.dataset.tab === 'register');
                });
            });
            DOMElements.showRegister.addEventListener('click', e => { e.preventDefault(); DOMElements.authTabs[1].click(); });
            DOMElements.showLogin.addEventListener('click', e => { e.preventDefault(); DOMElements.authTabs[0].click(); });

            // Search
            DOMElements.searchIcon.addEventListener('click', () => { DOMElements.searchHeader.classList.add('active'); DOMElements.searchInput.focus(); });
            DOMElements.closeSearch.addEventListener('click', () => DOMElements.searchHeader.classList.remove('active'));
            DOMElements.searchInput.addEventListener('input', handleSearch);

            // User Dropdown and Mobile Menu Auth links
            DOMElements.logoutLink.addEventListener('click', signOut);
            DOMElements.mobileLogout.addEventListener('click', signOut);
            DOMElements.loginBtn.addEventListener('click', () => openModal(DOMElements.authModal));
            DOMElements.mobileLogin.addEventListener('click', () => { DOMElements.mobileMenu.classList.remove('active'); openModal(DOMElements.authModal); });
            
            // Checkout
            DOMElements.checkoutButton.addEventListener('click', startCheckout);
            DOMElements.closeCheckout.addEventListener('click', () => closeSideModal(DOMElements.checkoutModal));
            DOMElements.checkoutBackButton.addEventListener('click', () => handleCheckoutNavigation('back'));
            DOMElements.checkoutNextButton.addEventListener('click', () => handleCheckoutNavigation('next'));
            DOMElements.orderConfirmation.closeButton.addEventListener('click', () => closeSideModal(DOMElements.checkoutModal));
            DOMElements.shippingMethodRadios.forEach(radio => radio.addEventListener('change', () => {
                document.querySelectorAll('.shipping-method').forEach(el => el.classList.remove('selected'));
                radio.closest('.shipping-method').classList.add('selected');
                prepareShippingMethodStep();
            }));

            DOMElements.paymentInfo.receiptImage.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    receiptFile = e.target.files[0];
                    DOMElements.paymentInfo.fileName.textContent = receiptFile.name;
                    DOMElements.paymentInfo.fileUploadButton.classList.add('uploaded');
                } else {
                    receiptFile = null;
                    DOMElements.paymentInfo.fileName.textContent = 'فایلی انتخاب نشده';
                    DOMElements.paymentInfo.fileUploadButton.classList.remove('uploaded');
                }
            });

            // Pull to refresh functionality
            let touchStartY = 0;
            let touchCurrentY = 0;
            let isPulling = false;

            DOMElements.body.addEventListener('touchstart', (e) => {
                if (window.scrollY === 0) {
                    touchStartY = e.touches[0].clientY;
                    isPulling = true;
                }
            });

            DOMElements.body.addEventListener('touchmove', (e) => {
                if (!isPulling) return;
                
                touchCurrentY = e.touches[0].clientY;
                const pullDistance = touchCurrentY - touchStartY;
                
                if (pullDistance > 0) {
                    DOMElements.pullToRefresh.style.top = Math.min(pullDistance, 80) - 50 + 'px';
                    
                    if (pullDistance > 100) {
                        DOMElements.pullToRefresh.classList.add('active');
                    }
                }
            });

            DOMElements.body.addEventListener('touchend', (e) => {
                if (!isPulling) return;
                
                const pullDistance = touchCurrentY - touchStartY;
                
                if (pullDistance > 100) {
                    // Refresh action
                    window.location.reload();
                }
                
                // Reset
                DOMElements.pullToRefresh.style.top = '-50px';
                DOMElements.pullToRefresh.classList.remove('active');
                isPulling = false;
            });
        };
        
        const handleSearch = () => {
            const query = DOMElements.searchInput.value.trim().toLowerCase();
            DOMElements.searchResults.innerHTML = '';
            
            if (query.length < 2) {
                DOMElements.searchResults.style.display = 'none';
                return;
            }
            
            const results = perfumes.filter(p => p.name.toLowerCase().includes(query));
            if (results.length === 0) {
                DOMElements.searchResults.innerHTML = '<div style="padding: 20px; text-align: center; color: #777;">محصولی یافت نشد</div>';
            } else {
                results.forEach(perfume => {
                    const item = document.createElement('div');
                    item.className = 'search-result-item';
                    item.innerHTML = `<img src="${perfume.image}" alt="${perfume.name}" class="search-result-image"><div><div class="search-result-name">${perfume.name}</div></div>`;
                    item.addEventListener('click', () => {
                        showProductDetails(perfume);
                        DOMElements.searchHeader.classList.remove('active');
                    });
                    DOMElements.searchResults.appendChild(item);
                });
            }
            DOMElements.searchResults.style.display = 'block';
        };

        // --- END: Event Listeners ---
        
        // --- START: Initialization ---
        const init = () => {
            generateProductCards();
            updateCartCount();
            updateWishlistCount();
            setupEventListeners();
            setupAuthEventListeners();
            setupUserModals();
            setupLocationDropdowns();
            auth.onAuthStateChanged(handleAuthStateChanged);
        };

        window.addEventListener('DOMContentLoaded', init);
        // --- END: Initialization ---

    </script>
</body>
</html>
